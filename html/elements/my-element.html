<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="my-element" noscript attributes="color owner">
  <template>
    <div style="{{ mainStyle | styleObject }}">
        <span>I'm <b>my-element</b>. This is my Shadow DOM. And its for {{owner | plusOne}}.</span>
        <core-ajax url="/json.html" auto response="{{resp}}"></core-ajax>
        <textarea value="{{resp}}" style="display:block"></textarea>
        <div id="thePerson" style="color: {{color}}">Waiting...</div>
        <div layout horizontal>
            <button on-click="{{setFocus}}" hidden?="{{moreThanOne}}">Set focus on owner</button>
            <button on-click="{{cloneThis}}">Clone this</button>
            <button on-click="{{deleteThis}}" id="deleteButton">{{deleteText}}</button>
            <input id="nameInput" value="{{owner | toUpperCase }}"
                   placeholder="Enter name..." flex>
            <input id="oneTime" value="[[onetime]]" placeholder="One time deal..." />
            <input id="somethingDeep" />
        </div>
    </div>
    <table>
        <tr template repeat="{{tr in rows}}">
            <td>{{tr}}</td>
        </tr>
    </table>
  </template>
  <script>
    Polymer({
        mainStyle: {color:'red', background: '#efefef', height: '120px', 'margin-bottom': '5px', padding: '3px'},
        owner: "Someone",
        color: "red",
        typed: true,
        deleteText: "Delete This",
        moreThanOne: false,
        onetime: "just once",
        deep: {
            something: {
                deep: "",
            }
        },
        ready: function () {
            this.$.thePerson.textContent = this.owner + " thinks this is cool."
            this.$.somethingDeep.bind('value', new PathObserver(this.deep, 'something.deep'));
        },
        attached: function () {
            this.hideOrShowDelete();
            this.moreThanOne = this.isMoreThanOneMyElement();
        },
        detached: function () {
            this.hideOrShowDelete();

        },
        hideOrShowDelete: function () {
            var display = (this.numMyElements() > 1) ? "inline-block" : "none";
            var elms = document.getElementsByTagName('my-element');
            for (var ii = 0; ii < elms.length; ii++) {
                elms[ii].$.deleteButton.style.display = display;
            }
        },
        toggleTextColor:  function (oldValue, newValue) {
            if (this.typed) {
                this.color = "blue";
            } else {
                this.color = "black";
            }
            this.typed = !this.typed;
            this.deep.something.deep = "the color is " + this.color;
        },
        updateListeningElement: function (oldValue, newValue) {
            this.toggleTextColor(oldValue, newValue);
            this.fire('wow');
        },
        observe: {
            owner: 'updateListeningElement',
        },
        setFocus: function () {
            this.$.nameInput.focus();
        },
        cloneThis: function(evt, detail, sender) {
            var el = document.createElement('my-element');
            document.querySelector('my-app').$.myElements.appendChild(el);

            if (sender.textContent.indexOf("CLONED") < 0) {
                var noticeTag = document.createElement('span');
                noticeTag.textContent = " - CLONED";
                sender.insertBefore(noticeTag);
            }
        },
        deleteThis: function (evt, detail, sender) {
            this.remove();
        },
        numMyElements: function () {
            return document.getElementsByTagName('my-element').length;
        },
        isMoreThanOneMyElement: function () {
            return this.numMyElements() < 2;
        },
        toUpperCase: {
            toDOM: function (val) {
                return val.toUpperCase();
            },
            toModel: function (val) {
                return val.toUpperCase();
            }
        },
    });

    PolymerExpressions.prototype.plusOne = function (val) {
        return val + " one ";
    };

  </script>
</polymer-element>